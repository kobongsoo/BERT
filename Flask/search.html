<head>
    <meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
</head>
<body style="margin: 30;">
    <div class="card border-dark mb-3" style="min-width: 30rem; max-width: 30rem;">
      <div class="card-header">엘라스틱서치 검색예제</div>
      <div class="card-body text-dark">
        <h8 class="card-title">검색어를 입력하면 ES에서 코사인유사도 측정 후 가장 유사한 문장들을 보여줍니다.</h8>
		<input type="text" class="form-control" aria-describedby="basic-addon3" id="esindex" name="esindex", placeholder="엘라스틱서치 검색 index 명칭 입력"/>
		<input type="text" class="form-control" aria-describedby="basic-addon3" id="searchsize" name="searchsize" placeholder="검색계수 입력 (예: 5)"/>

		<select id="bitext">
			<option value="0">=[bi-encode]검색어와 비교할 문장 선택=</option>
			<option value="1">제목</option>
			<option value="2">요약문(평균)</option>
			<option value="3">본문</option>
		</select>

		<select id="cetext">
			<option value="0">=[cross-encode]검색어와 비교할 문장 선택=</option>
			<option value="1">제목</option>
			<option value="2">요약문</option>
			<option value="3">제목+요약문</option>
		</select>

  		<input type="text" class="form-control" aria-describedby="basic-addon3" id="texts" name="texts" onkeypress="if(event.keyCode==13) {api_call(); return false;}" placeholder="검색어를 입력하고, Enterkey를 누르세요"/>
        <p class="card-text">
            <div class="alert alert-info" role="alert"> 				
				<p id="count" class="mb-0"></p>
				<p></p>
               	<p id="result-search" class="mb-0"></p>
            </div>
        </p>
        <hr>
        <p class="card-text"><small class="text-muted">검색예제</small></p>
      </div>
    </div>
</body>

<script>
function api_call() {

	var esindex = $("#esindex").val();			// form에 입력한 ES 검색 인덱스명 가져옴
	var searchsize = $("#searchsize").val();	// form에 입력한 검색계수 가져옴

	// bi-encoder 비교 문장 가져옴
	var bitextdoc = document.getElementById('bitext');			
	var bitext = bitextdoc.options[bitextdoc.selectedIndex].value;

	// cross-encode 비교 문장 가져옴
	var cetextdoc = document.getElementById('cetext');			
	var cetext = cetextdoc.options[cetextdoc.selectedIndex].value;

    var texts = $("#texts").val();				// form에 업력한 검색어 가져옴

	console.log(bitext)		  // bi-encode 비교 문장 종류 뿌려봄
	console.log(cetext)		  // cross-encode 비교 문장 종류 뿌려봄
	console.log(searchsize)   // 검색계수 콘솔에 뿌려봄 
	console.log(texts);	      // 검색어 콘솔에 뿌려봄

    $.ajax({
		//+=======================================================================================
		// **엘라스틱서치 서버 정보를 추가해서 url 구성해야 함.
	    // =>esurl={elasticsearch 서버 url}&index={elasticserch 검색 index}
        // url: "/essearch?esurl=http://192.168.0.27:9200/&index=aihub-ts1-albert-small-kor-sbert-v1.1-bwsg",
		url: "/essearch?esurl=http://192.168.0.27:9200/",
        //+=======================================================================================
		method: 'POST',
        contentType: 'application/json',
		dataType: 'JSON',
		cache: false,

		// 전송할 데이터 구성(json 형식)
        data: JSON.stringify({
		'bitext': bitext,   // bi-encode 비교 문장 종류(제목, 요약문, 본문)
		'cetext': cetext,   // cross-encode 비교 문장 종류(제목, 요약문, 제목+요약문)
		'index': esindex,   // ES 검색 인덱스명
		'size': searchsize, // 검색계수
		'text':texts,       // 검색어
		}),
		
		success: sucessHandler, // 성공 처리 함수 호출
		error: errorHandler,    // 에러 처리 함수 호출 

        timeout: 30000          // 타임아웃시간: 30초로 늘림
    });
}

// 성공시 처리 함수 
function sucessHandler( data, textStatus, jQxhr )
{
	// 크롬/엣지등에서 [ctrl]+[shift]+j 누르면 console 디버깅 창을 볼수 있음.
	console.log("data:", data );					
	console.log("len:", data.results.length)
	
	// 검색수, 쿼리벡터생성시간(임베딩시간), es 검색시간, cross 인코딩처리시간 등을 표기해줌.
	var info_result = "*검색수: "+data.count + "</br>" +"*쿼리벡터생성시간(ms): " + data.qembedtime + "</br>" +"*ES검색시간(ms): " + data.essearchtime + "</br>" +"*Cross인코딩시간(ms): " + data.crosstime
	$('#count').html(info_result);  // 검색 계수 출력

	var str_result = ''; // str 변수 초기화

	// results 목록을 순서대로 읽어와서 json 문자열로 변환함.
	for(var i=0;i<data.results.length;i++)
	{
		var count = i+1
		var result = "("+count+") "+"제목: "+data.results[i].title+"</br>"+"cross: "+data.results[i].cross_score+"</br>"+"es: "+data.results[i].es_score+"</br>"+"요약문:"+"</br>"+data.results[i].summarize+"</br></br>"
		//console.log("result:",result)

		// jsvascript 값=>json 문자열로 변환 
		str_result += JSON.stringify(result)
	}

	str_result = str_result.replace(/\"/gi, "");   // JSON.stringify 출력하면 "(큰따옴표) 생성되는데 이를 제거함.
	//console.log("str_result:",str_result)

	$('#result-search').html(str_result);    // 결과text 출력
}

// 에러시 처리 함수 
function errorHandler( request, textStatus, errorThrown )
{
	var error = textStatus + " : " + errorThrown + "</br>" + request.responseText
	//var str_error = JSON.stringify(error)
    $('#result-search').html(error);

    console.log( errorThrown );
	console.log( textStatus );
	console.log(request.responseText)
}
</script>